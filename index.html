<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cheshire Academy Chatbot</title>
  <style>
    :root{
      /* Theme colors & shadows */
      --ca-navy: #041e42;                    /* Hover/active color (navy) */
      --ca-navyA: rgba(13,28,52,.28);        /* Default semi-transparent button */
      --ca-shadow: 0 18px 50px rgba(0,0,0,.28);
      --ca-radius: 16px;

      /* Chat window base size (keep inner font size unchanged) */
      --ca-w: 640px;   /* Desktop width */
      --ca-h: 750px;   /* Desktop height */
      --ca-compact: .67; /* When opened, outer box shows at 2/3 scale (~ one-third smaller) */
    }

    /* Bottom-right bubble container (initially positioned with right/bottom; switches to left/top after first drag) */
    #ca-chat-bubble{ position:fixed; right:20px; bottom:20px; z-index:9999; }

    /* Round button: semi-transparent + backdrop blur; hover = opaque navy; draggable */
    #ca-open{
      position:relative; width:72px; height:72px; border-radius:50%;
      border: 1px solid rgba(255,255,255,.22);
      background: var(--ca-navyA);
      color:#fff; cursor:grab; outline:0;
      box-shadow: var(--ca-shadow);
      backdrop-filter: blur(18px) saturate(160%) contrast(1.05);
      -webkit-backdrop-filter: blur(18px) saturate(160%) contrast(1.05);
      transition: background-color .25s ease, transform .12s ease, opacity .25s ease;
      overflow:hidden; display:flex; align-items:center; justify-content:center;
    }
    #ca-open:active{ cursor:grabbing; transform: scale(.98); }
    #ca-open:hover, #ca-open.active{ background: var(--ca-navy); }

    /* Glassy highlight/inner shadow for the button (doesn't change opacity) */
    #ca-open::before{
      content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background:
        radial-gradient(120% 120% at 20% 12%, rgba(255,255,255,.38), rgba(255,255,255,.12) 44%, rgba(255,255,255,0) 60%),
        radial-gradient(90% 90% at 80% 88%, rgba(0,0,0,.22), rgba(0,0,0,0) 60%);
      mix-blend-mode:screen;
    }

    /* Premium-looking robot icon (gradient stroke, follows currentColor) */
    #ca-open svg{ width:32px; height:32px; display:block; }

    /* Liquid ripple */
    #ca-open .ripple{
      position:absolute; border-radius:50%; pointer-events:none;
      transform: scale(0); opacity:.55;
      background: radial-gradient(closest-side, rgba(255,255,255,.9), rgba(255,255,255,.35), rgba(255,255,255,0));
      animation: ca-ripple .7s ease-out forwards; mix-blend-mode: screen;
    }
    @keyframes ca-ripple{ to{ transform: scale(7); opacity:0; } }

    /* Transparent overlay for closing on outside click */
    #ca-overlay{ position:fixed; inset:0; display:none; background:transparent; z-index:9998; }

    /* Panel shell: liquid glass (blur + saturate + highlights) */
    #ca-panel{
      position:fixed; right:20px; bottom:110px; display:none; z-index:9999;
      border-radius: var(--ca-radius); overflow:hidden; box-shadow: var(--ca-shadow);
      background: linear-gradient( to bottom right, rgba(255,255,255,.28), rgba(255,255,255,.18) );
      border: 1px solid rgba(255,255,255,.38);
      backdrop-filter: blur(22px) saturate(180%) brightness(1.08);
      -webkit-backdrop-filter: blur(22px) saturate(180%) brightness(1.08);
    }
    #ca-panel::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(120% 120% at 12% 8%, rgba(255,255,255,.55), rgba(255,255,255,.12) 38%, rgba(255,255,255,0) 60%),
        radial-gradient(90% 90% at 88% 92%, rgba(0,0,0,.18), rgba(0,0,0,0) 60%);
      mix-blend-mode: screen;
    }

    /* Title bar (holds language menu, avoids covering content) */
    #ca-panel .bar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px 14px 0 14px;
      font: 600 16px/1.3 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:#1a1f36;
    }
    #ca-panel .bar .title{ padding-left:2px; }
    #ca-panel .bar .lang{
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(0,0,0,.06);
      border-radius: 10px; padding:6px 8px;
      backdrop-filter: blur(8px);
    }
    #ca-panel .bar .lang svg{ width:16px; height:16px; opacity:.9; }
    #ca-panel .bar select{
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      border:none; background:transparent; outline:none; cursor:pointer;
      font: 600 13px/1.1 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:#1a1f36; padding-right:18px;
    }

    /* Inner frame & content: no transform scaling; control width/height instead */
    #ca-panel .frame{ position:relative; padding:12px; }
    #ca-panel .content{ position:relative; width: var(--ca-w); height: var(--ca-h); }

    /* When opened: white box shown at 2/3 size; inner font size unchanged */
    #ca-panel.compact .content{
      width:  calc(var(--ca-w) * var(--ca-compact));
      height: calc(var(--ca-h) * var(--ca-compact));
    }

    /* Subtle vibrancy (non-interactive) */
    #ca-panel .vibrancy{
      position:absolute; inset:0; border-radius:12px; pointer-events:none;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0)),
        radial-gradient(60% 40% at 20% 4%, rgba(255,255,255,.07), rgba(255,255,255,0) 60%);
      mix-blend-mode: screen;
    }

    /* Make iframe fill the content box and stay crisp */
    #ca-panel iframe{
      width: 100%; height: 100%;
      border:0; display:block; border-radius: 12px; background:#fff;
    }

    @media (max-width:520px){
      :root{
        --ca-w: 92vw;  /* On small screens use viewport-relative sizes */
        --ca-h: 70vh;
        --ca-compact: .85; /* On phones, keep less shrink for readability; set back to .67 if you want consistency */
      }
    }
    @media (prefers-reduced-motion: reduce){
      #ca-open .ripple{ display:none!important; }
      #ca-open{ transition:none; }
    }
  </style>
</head>
<body>

<!-- Transparent overlay: click empty area to close -->
<div id="ca-overlay"></div>

<div id="ca-chat-bubble">
  <button id="ca-open" aria-label="Chat with CA" title="Chat with CA">
    <!-- Premium-looking robot icon (SVG gradient stroke) -->
    <svg viewBox="0 0 24 24" fill="none" stroke="url(#g)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse">
          <stop offset="0"  stop-color="#E6F0FF"/>
          <stop offset=".5" stop-color="#BFD4FF"/>
          <stop offset="1"  stop-color="#7FB2FF"/>
        </linearGradient>
      </defs>
      <rect x="4" y="7" width="16" height="12" rx="6"></rect>
      <circle cx="9"  cy="13" r="1.6"></circle>
      <circle cx="15" cy="13" r="1.6"></circle>
      <path d="M12 7V4"></path>
      <path d="M7 19c1.5 1 3.2 1.5 5 1.5s3.5-.5 5-1.5"></path>
      <path d="M3 12h2M19 12h2"></path>
    </svg>
  </button>

  <div id="ca-panel" role="dialog" aria-modal="true" aria-label="Cheshire Academy Chat">
    <div class="bar">
      <div class="title">Cheshire Academy Chatbot</div>
      <div class="lang" title="Language">
        <!-- Globe icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="#172033" stroke-width="1.6">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M3 12h18M12 3a12.5 12.5 0 0 1 0 18M12 3a12.5 12.5 0 0 0 0 18"></path>
        </svg>
        <select id="ca-lang" aria-label="Language">
          <option value="auto">üåê Auto / Ëá™Âä® (auto)</option>
          <option value="en">English</option>
          <option value="es">Espa√±ol</option>
          <option value="zh">‰∏≠Êñá</option>
          <option value="fr">Fran√ßais</option>
          <option value="de">Deutsch</option>
          <option value="ja">Êó•Êú¨Ë™û</option>
          <option value="ko">ÌïúÍµ≠Ïñ¥</option>
          <option value="pt">Portugu√™s</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        </select>
      </div>
    </div>

    <div class="frame">
      <div class="content">
        <div class="vibrancy"></div>
        <iframe
          id="ca-iframe"
          src=""
          allow="clipboard-read; clipboard-write; microphone; camera; geolocation"
          sandbox="allow-scripts allow-forms allow-same-origin allow-downloads allow-popups"
          loading="lazy"
        ></iframe>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // ====== Config: set this to your Space base URL (without query params) ======
  const IFRAME_BASE = "https://abyss2009-chatgpt-chatbot.hf.space/";
  const DEFAULT_THEME = "light";

  // ====== DOM refs ======
  const btn     = document.getElementById('ca-open');
  const bubble  = document.getElementById('ca-chat-bubble');
  const panel   = document.getElementById('ca-panel');
  const overlay = document.getElementById('ca-overlay');
  const iframe  = document.getElementById('ca-iframe');
  const langSel = document.getElementById('ca-lang');

  // ====== Utils ======
  const isOpen = () => panel.style.display === 'block';
  const getSavedLang = () => localStorage.getItem('ca_lang') || 'auto';
  const setSavedLang = (v) => localStorage.setItem('ca_lang', v);

  function buildSrc(){
    const lang = getSavedLang();
    const url = new URL(IFRAME_BASE);
    url.searchParams.set("__theme", DEFAULT_THEME);
    if (lang && lang !== "auto") url.searchParams.set("lang", lang);
    return url.toString();
  }

  function updateIframe(){
    iframe.src = buildSrc();
  }

  // Initialize language & first src
  langSel.value = getSavedLang();
  updateIframe();

  langSel.addEventListener('change', () => {
    setSavedLang(langSel.value);
    updateIframe();
  });

  function positionPanelToButton(){
    const b  = bubble.getBoundingClientRect();
    const pw = panel.offsetWidth  || 420;
    const ph = panel.offsetHeight || 700;
    const left = Math.min(window.innerWidth - pw - 10, Math.max(10, b.left + b.width - pw));
    const top  = Math.max(10, b.top - (ph + 18));
    panel.style.left = left + 'px';
    panel.style.top  = top  + 'px';
    panel.style.right = 'auto';
    panel.style.bottom= 'auto';
  }

  function showRipple(ev){
    const rect = btn.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height)*1.2;
    const r = document.createElement('span');
    r.className = 'ripple';
    const pt = getPoint(ev, true, rect);
    r.style.width = r.style.height = size + 'px';
    r.style.left = (pt.x - rect.left - size/2) + 'px';
    r.style.top  = (pt.y - rect.top  - size/2) + 'px';
    btn.appendChild(r);
    setTimeout(()=> r.remove(), 750);
  }

  function openPanel(ev){
    panel.style.display = 'block';
    overlay.style.display = 'block';
    btn.classList.add('active');
    panel.classList.add('compact');      // Use compact size when opened (smaller white box, font unchanged)
    positionPanelToButton();
    if (ev) showRipple(ev);
  }
  function closePanel(){
    panel.style.display = 'none';
    overlay.style.display = 'none';
    btn.classList.remove('active');
    panel.classList.remove('compact');
  }
  function togglePanel(ev){ isOpen() ? closePanel() : openPanel(ev); }

  // ---------- Drag vs tap detection (Pointer Events) ----------
  let dragging=false, moved=false;
  let startX=0, startY=0, startLeft=0, startTop=0, usingLeftTop=false;
  const THRESHOLD = 6;      // Movement > 6px counts as dragging
  let swallowClick=false;   // Swallow the click that immediately follows pointerup (avoid double toggle)

  function ensureLeftTopPosition(){
    if (usingLeftTop) return;
    const rect = bubble.getBoundingClientRect();
    bubble.style.left = rect.left + 'px';
    bubble.style.top  = rect.top  + 'px';
    bubble.style.right= 'auto';
    bubble.style.bottom='auto';
    usingLeftTop = true;
  }

  function onPointerDown(ev){
    btn.setPointerCapture?.(ev.pointerId);
    ensureLeftTopPosition();
    dragging = true;
    moved    = false;
    const pt = getPoint(ev);
    startX = pt.x; startY = pt.y;
    const rect = bubble.getBoundingClientRect();
    startLeft = rect.left; startTop = rect.top;
  }

  function onPointerMove(ev){
    if (!dragging) return;
    const pt = getPoint(ev);
    const dx = pt.x - startX;
    const dy = pt.y - startY;
    if (!moved && (Math.abs(dx) > THRESHOLD || Math.abs(dy) > THRESHOLD)) moved = true;
    if (!moved) return;

    let left = startLeft + dx;
    let top  = startTop  + dy;
    const margin=10, bw=bubble.offsetWidth, bh=bubble.offsetHeight;
    left = Math.min(window.innerWidth - bw - margin, Math.max(margin, left));
    top  = Math.min(window.innerHeight - bh - margin, Math.max(margin, top));
    bubble.style.left = left + 'px';
    bubble.style.top  = top  + 'px';

    if (isOpen()) positionPanelToButton();
    ev.preventDefault();
  }

  function onPointerUp(ev){
    if (!dragging) return;
    dragging=false;

    // Swallow the upcoming click regardless of movement to avoid double toggle
    swallowClick = true;
    setTimeout(()=> swallowClick=false, 0);

    if (moved){
      // Drag ended: only move, do not open
      return;
    }
    // Tap: toggle
    togglePanel(ev);
  }

  function getPoint(ev, useCenter=false, rect=null){
    if (ev && (ev.clientX !== undefined)) return {x: ev.clientX, y: ev.clientY};
    if (ev && ev.changedTouches && ev.changedTouches[0])
      return {x: ev.changedTouches[0].clientX, y: ev.changedTouches[0].clientY};
    if (useCenter && rect) return {x: rect.left + rect.width/2, y: rect.top + rect.height/2};
    return {x:0, y:0};
  }

  // Unified pointer handling (mouse/touch)
  btn.addEventListener('pointerdown', onPointerDown);
  window.addEventListener('pointermove', onPointerMove, {passive:false});
  window.addEventListener('pointerup',   onPointerUp);

  // Swallow the click triggered by the pointer sequence (prevent duplicate toggle)
  btn.addEventListener('click', (e)=>{
    if (swallowClick){ e.preventDefault(); e.stopPropagation(); return; }
    // Fallback: toggle via click only if pointer events don't fire
    togglePanel(e);
  });

  // ---------- Close on outside click / ESC ----------
  document.addEventListener('click', (e)=>{
    if (!isOpen()) return;
    if (!panel.contains(e.target) && e.target !== btn) closePanel();
  });
  overlay.addEventListener('click', closePanel);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && isOpen()) closePanel(); });
})();
</script>
</body>
</html>